<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>浅析Binder机制 | RRRay</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="并没有找到讲binder机制特别清晰的中文资料
终于在youtube上找到一个演讲和slides,以及这篇资料作为补充，从更全面的角度介绍了更细致的前因后果的">
<meta property="og:type" content="article">
<meta property="og:title" content="浅析Binder机制">
<meta property="og:url" content="http://potatoker.github.io/2016/08/17/Binder/index.html">
<meta property="og:site_name" content="RRRay">
<meta property="og:description" content="并没有找到讲binder机制特别清晰的中文资料
终于在youtube上找到一个演讲和slides,以及这篇资料作为补充，从更全面的角度介绍了更细致的前因后果的">
<meta property="og:image" content="http://potatoker.github.io/images/Screen%20Shot%202016-07-24%20at%2010.20.14%20AM.png">
<meta property="og:image" content="http://potatoker.github.io/images/Screen%20Shot%202016-07-24%20at%2010.18.48%20AM.png">
<meta property="og:image" content="http://potatoker.github.io/images/Screen%20Shot%202016-07-24%20at%2010.38.53%20AM.png">
<meta property="og:image" content="http://potatoker.github.io/images/Screen%20Shot%202016-07-24%20at%2011.17.30%20AM.png">
<meta property="og:updated_time" content="2016-08-17T04:10:39.355Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浅析Binder机制">
<meta name="twitter:description" content="并没有找到讲binder机制特别清晰的中文资料
终于在youtube上找到一个演讲和slides,以及这篇资料作为补充，从更全面的角度介绍了更细致的前因后果的">
  
    <link rel="alternative" href="/atom.xml" title="RRRay" type="application/atom+xml">
  
  
    <link rel="icon" href="/bitbug_favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
  
<script type="text/javascript">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?4a29d5d0695722aee984078a58609060";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</script>

</head>
<body>
  <div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/">RRRay</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li>
			<li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li>
			<li><a href="/atom.xml" id="nav-rss-link" class="nav-icon" title="RSS Feed"></a></li>
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://potatoker.github.io"></form>
	</div>
</header>
    <div id="main">
      <article id="post-Binder" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2016/08/17/Binder/" class="article-date">
  <time datetime="2016-08-17T03:51:30.000Z" itemprop="datePublished">2016-08-17</time>
</a>
		</span>
		<span class="meta-elements author">RRRay</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 class="article-title entry-title" itemprop="name">
      浅析Binder机制
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>并没有找到讲binder机制特别清晰的中文资料</p>
<p>终于在youtube上找到一个<a href="https://www.youtube.com/watch?v=Jgampt1DOak" target="_blank" rel="external">演讲</a>和<a href="http://events.linuxfoundation.org/images/stories/slides/abs2013_gargentas.pdf" target="_blank" rel="external">slides</a>,以及<a href="https://www.nds.rub.de/media/attachments/files/2012/03/binder.pdf" target="_blank" rel="external">这篇</a>资料作为补充，从更全面的角度介绍了更细致的前因后果的</p>
<a id="more"></a>
<p><img src="/images/Screen%20Shot%202016-07-24%20at%2010.20.14%20AM.png" alt=""></p>
<p>首先看这张把最主要的几个部分显示出来的图，可以看到process A和B的通信稍显曲折，这也是看到其他博客整片”A调用B,B又调用C”的原因。</p>
<p>这里还有一个类之间的调用关系抽象图，同样截取自上面的youtube presentation的slides。</p>
<p><img src="/images/Screen%20Shot%202016-07-24%20at%2010.18.48%20AM.png" alt="Screen Shot 2016-07-24 at 10.18.48 A"></p>
<p>这里首先有个基本的概念。进程间的通信，比如你在进程A 里面用service.invoke(func)，所谓IPC是真正的执行主体是在进程B，这里</p>
<h2 id="u8FD9_u91CC_u5148_u8BF4_u4E00_u4E2A_u95EE_u9898_uFF0C_u4E3A_u4EC0_u4E48_u8981_u7528cs_u7ED3_u6784_uFF1F_u4E3A_u4EC0_u4E48_u8981_u7528IPC_u901A_u4FE1_3F"><a href="#u8FD9_u91CC_u5148_u8BF4_u4E00_u4E2A_u95EE_u9898_uFF0C_u4E3A_u4EC0_u4E48_u8981_u7528cs_u7ED3_u6784_uFF1F_u4E3A_u4EC0_u4E48_u8981_u7528IPC_u901A_u4FE1_3F" class="headerlink" title="这里先说一个问题，为什么要用cs结构？为什么要用IPC通信?"></a>这里先说一个问题，为什么要用cs结构？为什么要用IPC通信?</h2><p>其实在一个系统中client和server的概念还是挺明确的，用户程序常常要使用一些通用的系统服务，gps,alarm等等，这些肯定是安卓系统负责去维护的。包括开一个activity，task栈是可以跨进程的，维护这个栈肯定也是系统去维护。</p>
<p>既然这么多需要系统去同意维护的服务，那么就采用c/s结构，上面的各个client都可以向系统请求这些服务，系统也方便管理。</p>
<p>显然，系统服务和用户进程是两个进程，他们之间的通信是IPC。</p>
<h2 id="u4E00_u76F4_u5728_u8BF4_u7684binder_u5230_u5E95_u662F_u4E2A_u4EC0_u4E48_u4E1C_u897F"><a href="#u4E00_u76F4_u5728_u8BF4_u7684binder_u5230_u5E95_u662F_u4E2A_u4EC0_u4E48_u4E1C_u897F" class="headerlink" title="一直在说的binder到底是个什么东西"></a>一直在说的binder到底是个什么东西</h2><p>一般Binder，就是指binder机制，在一些描述中，有的会说把这个binder传给谁。不过在上面两篇里面基本很少这么使用。</p>
<p>先看资料给出的定义:</p>
<ul>
<li>IBinder InterfaceA well-defined behavior (i.e. methods) that Binder Objects must implement</li>
</ul>
<ul>
<li><p>Binder (Object)A generic implementation of the IBinder interface</p>
</li>
<li><p>Binder TokenAn abstract 32-bit integer value that uniquely identifies a Binder object across all processes on the system</p>
</li>
</ul>
<p>主要是binder(object)的解释，就是只要实现了ibinder的就是binder，这个ibider类根据下面的知道就是android.os.Binder<br>再看看上面的图，整个binder框架中会用到的类，就是那么几个，那么这个和android.os.Binder有关的类是哪个？</p>
<p>当然详细的关于这几个类的分析在后面，但是现在就可以给出答案,可以看了后面再跳回来看:</p>
<p>这是一个使用AIDL帮我们生成的类的类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> others;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by raymond on 7/24/16.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">package</span> com.example.app;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IFooService</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">app</span>.<span class="title">IFooService</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> com.example.app.<span class="function">IFooService <span class="title">asInterface</span><span class="params">(</span><br><span class="line">                android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> com.example.app.IFooService.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span></span><br><span class="line">                flags)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123; <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">case</span> TRANSACTION_save: &#123;</span><br><span class="line">                ...</span><br><span class="line">                com.example.app.Bar _arg0;</span><br><span class="line">                ...</span><br><span class="line">                _arg0 = com.example.app.Bar.CREATOR.createFromParcel(data);</span><br><span class="line">                <span class="keyword">this</span>.save(_arg0);</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            ... &#125;</span><br><span class="line">            ... &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">app</span>.<span class="title">IFooService</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line">            ...</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(com.example.app.Bar bar)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                ...</span><br><span class="line">                bar.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">                ...</span><br><span class="line">                mRemote.transact(Stub.TRANSACTION_save, _data, _reply, <span class="number">0</span>); ...</span><br><span class="line">            &#125; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没错，就是调用图里面的那个service.stub类，是一个抽象类，他<code>extends android.os.Binder</code>这个类算作是要和C++ middleware(上图调用层里面的libbinder)通信的类，是java层面service的最下面的类。他的主要方法是ontrasict()，向这个transic data里面设置一些值，这些值可能就是返回值，ontransict()就是在他收到C++ middleware的trasiction 的时候的回调函数，他通过执行本地方法，得到结果保存到trancsiction里面并且返回。当然其实后面的比如serviceimp或者service都直接或者间接的extends了stub这个类，不过因为stub类是和c++ middleware打交道的类，是Binder机制语境中提到更多的类。</p>
<p>另外注意proxy这个类是被client使用的，他手上有stub类的引用，也就是有Binder的引用，所以也可以看到</p>
<p><code>mRemote.transact(Stub.TRANSACTION_save, _data, _reply, 0)</code></p>
<p>他在向binder发送这个transact data.并且这一动作是发生在client端的。</p>
<h2 id="u77E5_u9053_u4E86binder_u662F_u4E2Astub_uFF0C_u90A3_u4E48_uFF0C_u5230_u5E95_u600E_u4E48_u5B9E_u73B0_u7684IPC_u7684_u554A"><a href="#u77E5_u9053_u4E86binder_u662F_u4E2Astub_uFF0C_u90A3_u4E48_uFF0C_u5230_u5E95_u600E_u4E48_u5B9E_u73B0_u7684IPC_u7684_u554A" class="headerlink" title="知道了binder是个stub，那么，到底怎么实现的IPC的啊"></a>知道了binder是个stub，那么，到底怎么实现的IPC的啊</h2><p>其实所谓IPC，就是你要实现一套通信机制，这边说话那边你要听得懂，听不懂就找个中间人来翻译。同时要保证一个人说一个人听不会乱套，保证两个人不能抢着说。</p>
<p>其实你看linux里面ipc</p>
<ol>
<li>socket方式，本来就是网络进程间通信方式，是在tcp之上的一套通信协议，肯定能额保证两边正常对话。</li>
<li>pipe，其实就是两个process 一个拿读指针一个拿写指针去操作同一个文件，这个文件就是他们交流的管道，</li>
</ol>
<p>binder呢?</p>
<p>它主要做了一件事情就是prcess A中<code>service_local.func(arg)</code>，这个调用实际上发生在service进程里面，类似<code>service_remote.func(arg)</code>。</p>
<p>这里binder IPC要做的就是我不可能直接告诉你service_remote这个对象在process B里的真实地址，事实上即使你真的知道这个地址(一串数字)，由于JVM的机制，你也不可能调用func，去执行这个命令。这是出于安全的考虑，process之间有天然的隔阂。</p>
<p>这个时候，就要一个中间人，甚至更多的中间人来帮助他们沟通</p>
<p>这里最明显要有一个中间人在知道把这个service_local.func(arg)告诉对应的process B，并且让他在真实的service对象上进行一些列的操作。</p>
<p>这个把调用信息告诉中间人的方法就是把这个函数调用抽象成一个特定的数据结构(我干脆理解成网络通信里面的通信包似的)</p>
<p>这个数据结构就叫Transmission data,也有叫trasiction：</p>
<p><img src="/images/Screen%20Shot%202016-07-24%20at%2010.38.53%20AM.png" alt="Screen Shot 2016-07-24 at 10.38.53 A"></p>
<p>这个其实就跟网络通信的包一样嘛，几个域规定了几个特定的信息。</p>
<p>这个transmission data就描述了这次调用。包括</p>
<ul>
<li>是哪个service去调用(target)，这个target真实的情况是一个binder token</li>
</ul>
<p>ok,ok,ok,看一眼上面的binder Token是什么。</p>
<blockquote>
<p>An abstract 32-bit integer value that uniquely identifies a Binder object across all processes on the system</p>
</blockquote>
<p>先明确一点，这个进行翻译的中间人就是binder driver,看看binder driver怎么“翻译”的:</p>
<blockquote>
<p>On every transaction, the binder driver automaticallymaps local addresses to remote binder handles and remote binder handles to local addresses</p>
</blockquote>
<p>我们确认一下，这个local address就是我们上面说的binder Token吗:</p>
<blockquote>
<p>A binder object reference is one of the following </p>
<ul>
<li>An actual virtual memory address to a binder object in the same process* An abstract 32-bit handle to a binder object inanother process</li>
</ul>
</blockquote>
<p><img src="/images/Screen%20Shot%202016-07-24%20at%2011.17.30%20AM.png" alt="Screen Shot 2016-07-24 at 11.17.30 A"></p>
<p>我们这里谈general的情况，所以都是指IPC，所以属于第二种情况。所以，没错！transaciton的target的值就是一个binder Token,binder driver的作用就是把这个binder Token翻译成指向process B的binder(stub对象)的引用!!</p>
<blockquote>
<p>On every transaction, the binder driver automaticallymaps local addresses to remote binder handles and remote binder handles to local addresses</p>
</blockquote>
<p>至此，谜团差不多解开了。</p>
<p>其实就是process A向调B的某个方法，他不能直接调用，他把调用信息打包成一个叫trsaction的数据结构，这个结构中主要包括:</p>
<ul>
<li>哪个service对象去执行(binder token来表示)</li>
<li>这个serivice的哪个方法</li>
<li>进行过数据变换的一些函数参数（这个过程叫parcel）</li>
</ul>
<blockquote>
<p>Parcel: Container for a message (data and object references) that can be sent through an IBinder</p>
</blockquote>
<p>然后这个trascation会通过Linux ioctl命令(c++ middleware层在做这件事)发送到binder driver这个内核空间的一块区域，在这里保存着binder token到process B binder对象（stub对象，即service对象)的引用的映射。由此就找到了真正的service对象他收到transaciton中的调用信息，进行执行，然后把返回值信息设置进一个reply parcel，然后再调用iotcl把改变过的transaction发送给client里的proxy。</p>
<p>这个过程看上面的调用图应该很明白了。<br>这里我才醒悟的一点是，在返回的时候我在想，process B返回一个parcel而不是trascation也就是不指定地址?这不也是进程间通信吗，为什么这个就可以直接返回数据?难道不是和之前一样给一个地址符（binder Token吗）</p>
<p>不不不，注意这里client把trasaction通过iotcl给binder driver的时候的描述：(结合第二张调用图)</p>
<p>client：</p>
<ul>
<li>4)submit transaction/data via a blocking ioctl call</li>
</ul>
<p>service:</p>
<ul>
<li>5)wake up from a blocking iotcl call and get the transaction data</li>
</ul>
<p>service设置transaction<br>service：</p>
<ul>
<li>13）submit replyParcel via ioctl</li>
<li>14）wake up from a blocking ioctl call and get transaction reply data</li>
</ul>
<p>再看一段关于procss B 执行完相应方法后的描述:</p>
<blockquote>
<p>Again it is routed through the layers to the binder driver, that transfers the parcel and wakes up the sleeping client process and delivers the reply parcel to the proxy object. </p>
</blockquote>
<p>也就是说client在等待这个方法的完成.调用的client一直在binder driver的iotcl这个命令中等待，所以binder driver只需要拿到了返回的parcel，他又通过iotcl把返回parcel穿给这个等待的client就可以了。</p>
<p>所以你注意到了目前讲的全部都是阻塞式的调用。当然也可以实现非阻塞式调用。</p>
<h3 id="binder_token__u54EA_u91CC_u6765_u7684"><a href="#binder_token__u54EA_u91CC_u6765_u7684" class="headerlink" title="binder token 哪里来的"></a>binder token 哪里来的</h3><p>前面讲了这么多，这个binder token到底是什么，反正就是只要client知道了binder Token并把它装进tracsaction里，binder driver收到后就可以通过映射关系找到真正的binder handler了。</p>
<p>那么到底client是怎么获得binder Token 的？</p>
<p>这里看context Manager的描述:</p>
<blockquote>
<p>Each Binder that needs to publish its name due to being a service, submits a name and its Binder token to the service manager. Relying on that feature, the client must only know the name of a service and asks the service manager for the Binder address of the requested service.</p>
</blockquote>
<p>这个context Manager有个更常用的名字service Manager</p>
<p>service Manger也是一个service，没错，他在单独的线程一直运行着。</p>
<p>他的作用就是把service name映射成binder token, 每个service都需要注册，这个你是懂的，在manifest里面。注册就是发生在这个service Manager里面。生成一条记录:servcice name -&gt;binder token.</p>
<p>所以当client 请求其他服务的时候第一件要做的事情就是向service manager做出请求，然后通过Binder机制，得到要请求的服务的binder token传给proxy，proxy会放到transaction里面。</p>
<p>这里的问题上是，如果必须要通过service manger才能得到binder token (相当于service binder的地址)，那servicemanger自己的地址我怎么知道呢?</p>
<p>这个已经规定好了，向servicemanager请求服务，binder token 无需查询，就是0！直接用。</p>
<h3 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h3><p>好了，Binder机制差不多了吧。这里还是看上图，关键的有两个类，一个是stub类，一个是proxy类，分别是和c++ middleware打交道的属于service process和client process的两个类。</p>
<p>这两个类规定了如何parcel函数调用的参数。</p>
<p>其中</p>
<ul>
<li>stub类继承了ibinder，他就是常说的binder 对象,这一层是用来和transaction数据打交道的，把从C++ middle ware层收到的parcel参数转化为java 类型供上面的service的真正的实现使用的</li>
<li>proxy类拥有stub对象的引用service，也就是binder的引用(实际在放入transaction的时候是binder token)，他负责当client调用service.func的时候把参数进行parcel放入transcation然后传入C++ middleware层</li>
</ul>
<p>那么AIDL的作用就是:</p>
<p>你负责提供一个service的interface，也就是各个函数的声明(指示了参数类型，返回值类型，函数名)。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">package com.marakana.android.fibonaccicommon;import com.marakana.android.fibonaccicommon.FibonacciRequest; </span><br><span class="line">import com.marakana.android.fibonaccicommon.FibonacciResponse;</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IFibonacciService</span> &#123;	<span class="function"><span class="keyword">long</span> <span class="title">fibJR</span>(<span class="params"><span class="keyword">in</span> <span class="keyword">long</span> n</span>)</span>;	<span class="function"><span class="keyword">long</span> <span class="title">fibJI</span>(<span class="params"><span class="keyword">in</span> <span class="keyword">long</span> n</span>)</span>;	<span class="function"><span class="keyword">long</span> <span class="title">fibNR</span>(<span class="params"><span class="keyword">in</span> <span class="keyword">long</span> n</span>)</span>;	<span class="function"><span class="keyword">long</span> <span class="title">fibNI</span>(<span class="params"><span class="keyword">in</span> <span class="keyword">long</span> n</span>)</span>;	<span class="function">FibonacciResponse <span class="title">fib</span>(<span class="params"><span class="keyword">in</span> FibonacciRequest request</span>)</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>然后AIDL根据这个Interface就自动帮你生成上面的stub和proxy两个类(那两个类确实也只需要这些信息，他们的作用只是为这些类型提供parcel化而已)</p>
<p>所以AIDL的全称叫Android Interface Definition Language。<br>确实只是定义了一个interface而已。</p>
<h4 id="AIDL_u7684_u5177_u4F53_u64CD_u4F5C"><a href="#AIDL_u7684_u5177_u4F53_u64CD_u4F5C" class="headerlink" title="AIDL的具体操作"></a>AIDL的具体操作</h4><ol>
<li>java统计目录新键一个aild package（上面的例子直接叫fibonaccicommon了）</li>
<li>在这个package下新键一个.aidl文件,在里面声明接口</li>
<li>像上面那个例子用到了自定义的对象(FibonacciRequest和response)，那么就要Import这个类，同时要注意这个model类要implements parcelable才可以，上面一直强调了。</li>
<li>这个.aidl文件不只在server的app中要有，在client那边也必须要有个一样的。因为生成的类既有service process调用的stub又有client要调用的proxy.</li>
<li>build即可自动生成含有sutb和proxy的类了</li>
</ol>
<p>上面有写一个大致的自动生成的框架，今天刚好在网上看到了一个国内博客的<a href="http://android.jobbole.com/83957/" target="_blank" rel="external">Android 手写 Binder 教你理解 android 中的进程间通信-希尔瓦娜斯女神</a>，例子比较实在:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> others;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by raymond on 7/24/16.</span><br><span class="line"> */</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * This file is auto-generated.  DO NOT MODIFY.</span><br><span class="line"> * Original file: C:\\Users\\Administrator\\WriteBinderCodeExample\\app\\src\\main\\aidl\\com\\example\\administrator\\writebindercodeexample\\IPersonManager.aidl</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">package</span> com.example.administrator.writebindercodeexample;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPersonManager</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Local-side IPC implementation stub class.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">administrator</span>.<span class="title">writebindercodeexample</span>.<span class="title">IPersonManager</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"com.example.administrator.writebindercodeexample.IPersonManager"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Construct the stub at attach it to the interface.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Cast an IBinder object into an com.example.administrator.writebindercodeexample.IPersonManager interface,</span><br><span class="line">         * generating a proxy if needed.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> com.example.administrator.writebindercodeexample.<span class="function">IPersonManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">            <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> com.example.administrator.writebindercodeexample.IPersonManager))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((com.example.administrator.writebindercodeexample.IPersonManager) iin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> com.example.administrator.writebindercodeexample.IPersonManager.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">                    reply.writeString(DESCRIPTOR);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_getPersonList: &#123;</span><br><span class="line">                    data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                    java.util.List&lt;com.example.administrator.writebindercodeexample.Person&gt; _result = <span class="keyword">this</span>.getPersonList();</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    reply.writeTypedList(_result);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_addPerson: &#123;</span><br><span class="line">                    data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                    com.example.administrator.writebindercodeexample.Person _arg0;</span><br><span class="line">                    <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</span><br><span class="line">                        _arg0 = com.example.administrator.writebindercodeexample.Person.CREATOR.createFromParcel(data);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        _arg0 = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">this</span>.addPerson(_arg0);</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">administrator</span>.<span class="title">writebindercodeexample</span>.<span class="title">IPersonManager</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line"></span><br><span class="line">            Proxy(android.os.IBinder remote) &#123;</span><br><span class="line">                mRemote = remote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> mRemote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="keyword">public</span> java.util.List&lt;com.example.administrator.writebindercodeexample.Person&gt; getPersonList() <span class="keyword">throws</span> android.os.RemoteException &#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                java.util.List&lt;com.example.administrator.writebindercodeexample.Person&gt; _result;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_getPersonList, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                    _result = _reply.createTypedArrayList(com.example.administrator.writebindercodeexample.Person.CREATOR);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPerson</span><span class="params">(com.example.administrator.writebindercodeexample.Person person)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    <span class="keyword">if</span> ((person != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">                        person.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_addPerson, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getPersonList = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addPerson = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.util.List&lt;com.example.administrator.writebindercodeexample.Person&gt; getPersonList() <span class="keyword">throws</span> android.os.RemoteException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPerson</span><span class="params">(com.example.administrator.writebindercodeexample.Person person)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比较明显可以看到stub和proxy都是以子类的形式生成。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.SystemClock;<span class="keyword">import</span> android.util.Log;<span class="keyword">import</span> com.marakana.android.fibonaccicommon.FibonacciRequest; </span><br><span class="line"><span class="keyword">import</span> com.marakana.android.fibonaccicommon.FibonacciResponse; </span><br><span class="line"><span class="keyword">import</span> com.marakana.android.fibonaccicommon.IFibonacciService; </span><br><span class="line"><span class="keyword">import</span> com.marakana.android.fibonaccinative.FibLib;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IFibonacciServiceImpl</span> <span class="keyword">extends</span> <span class="title">IFibonacciService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"IFibonacciServiceImpl"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">long</span> <span class="title">fibJI</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, String.format(<span class="string">"fibJI(%d)"</span>, n));</span><br><span class="line">        <span class="function"><span class="keyword">return</span> FibLib.<span class="title">fibJI</span><span class="params">(n)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">long</span> <span class="title">fibJR</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, String.format(<span class="string">"fibJR(%d)"</span>, n));</span><br><span class="line">        <span class="function"><span class="keyword">return</span> FibLib.<span class="title">fibJR</span><span class="params">(n)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">long</span> <span class="title">fibNI</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, String.format(<span class="string">"fibNI(%d)"</span>, n));</span><br><span class="line">        <span class="function"><span class="keyword">return</span> FibLib.<span class="title">fibNI</span><span class="params">(n)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">long</span> <span class="title">fibNR</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, String.format(<span class="string">"fibNR(%d)"</span>, n));</span><br><span class="line">        <span class="function"><span class="keyword">return</span> FibLib.<span class="title">fibNR</span><span class="params">(n)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">FibonacciResponse <span class="title">fib</span><span class="params">(FibonacciRequest request)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG,</span><br><span class="line">                String.format(<span class="string">"fib(%d, %s)"</span>, request.getN(), request.getType()));</span><br><span class="line">        <span class="keyword">long</span> timeInMillis = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">long</span> result;</span><br><span class="line">        <span class="keyword">switch</span> (request.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> ITERATIVE_JAVA:</span><br><span class="line">                result = <span class="keyword">this</span>.fibJI(request.getN());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RECURSIVE_JAVA:</span><br><span class="line">                result = <span class="keyword">this</span>.fibJR(request.getN());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ITERATIVE_NATIVE:</span><br><span class="line">                result = <span class="keyword">this</span>.fibNI(request.getN());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RECURSIVE_NATIVE:</span><br><span class="line">                result = <span class="keyword">this</span>.fibNR(request.getN());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        timeInMillis = SystemClock.uptimeMillis() - timeInMillis;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FibonacciResponse(result, timeInMillis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我这里偷懒又回到了slides中的那个例子，这里就是在真正实现service 之前，又垫一层serviceimpl类,这个类是真正实现service功能的类，这里的fibonacci函数是调用的一个<code>com.marakana.android.fibonaccinative.FibLib</code>专门的库的类的函数来实现相关功能。</p>
<p>然后</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.marakana.android.fibonacciservice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FibonacciService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123; <span class="comment">// private static final String TAG = "FibonacciService"; private IFibonacciServiceImpl service; //</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="keyword">this</span>.service = <span class="keyword">new</span> IFibonacciServiceImpl(); <span class="comment">// Log.d(TAG, "onCreate()'ed"); //</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"onBind()'ed"</span>); <span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.service; <span class="comment">// &#125;</span></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onUnbind</span> <span class="params">(Intent intent)</span></span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"onUnbind()'ed"</span>); <span class="comment">//</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onUnbind</span><span class="params">(intent)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"onDestroy()'ed"</span>);</span><br><span class="line">            <span class="keyword">this</span>.service = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>终于到了我们之前在service里已经见过的正常的service的供app直接调用的service的类的实现了，这里onBind,onUnbind这些函数都是继承service应该实现的类。用来用作回调。</p>
<h3 id="Async_Binder_IPC"><a href="#Async_Binder_IPC" class="headerlink" title="Async Binder IPC"></a>Async Binder IPC</h3><p>前面我们分析过了之前讲的全是阻塞式的binder，也是就client要等待service返回，其中ioctl一直会挂起等待。</p>
<p>这里来看看如何生成异步的bidner IPC.</p>
<p>其实最好肯定是看代码,还是上面那个slides讲得不要更清楚。但是这里真的不能再贴代码了。。。。</p>
<p>原理很好理解，就是在写你再写一个interface叫IFibonacciServiceResponseListener,也就是说在client端调用service的函数的时候都要传一个这个listener的对象作为参数，这个对象当然是在client端生成并且实现的。</p>
<p>然后等到service执行完函数后，他没有return reuslt这种语句，而是调用listenr的onResponse这个回调函数。</p>
<p>看到这里明白了</p>
<p>对!service居然也在远程调用一个client对象(listener)。</p>
<p>要怎么实现?也用BInder啊!!所以解决办法就是用相同的办法去写listener和service的aidl，然后同时生成他俩的各种stub，proxy这些，总之就是listenr这个也是个服务对象了。</p>
<p>所以我们同时要写两个aidl文件:</p>
<p>唯一区别就是要在aidl文件中声明interface的时候要加上关键字oneway：</p>
<p>文件FibonacciCommon/src/com/marakana/android/fibonaccicommon/IFibonacciServiceResponseListener.aidl:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oneway <span class="keyword">interface</span> <span class="title">IFibonacciServiceResponseListener</span> &#123; </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onResponse</span>(<span class="params"><span class="keyword">in</span> FibonacciResponse response</span>)</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>文件FibonacciCommon/src/com/marakana/android/fibonaccicommon/IFibonacciService.aidl:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oneway <span class="keyword">interface</span> <span class="title">IFibonacciService</span> &#123;	<span class="function"><span class="keyword">void</span> <span class="title">fib</span>(<span class="params"><span class="keyword">in</span> FibonacciRequest request, <span class="keyword">in</span> IFibonacciServiceResponseListener listener</span>)</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>我想这个oneway的作用就是告诉ioctl不用挂起等待吧。一次性结束，当service要调用client的函数的时候他自己会重新走一遍进程间的通信流程。</p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java，Android/">java，Android</a></li></ul>

			</span>
		</div>
	</footer>
	
    
<nav id="article-nav">
  
    <a href="/2016/08/17/回溯法/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          回溯法
        
      </div>
    </a>
  
  
    <a href="/2016/08/16/OOM/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          图片OOM
        
      </div>
    </a>
  
</nav>

  
</article>



  
  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-Binder" data-title="浅析Binder机制" data-url="http://potatoker.github.io/2016/08/17/Binder/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'rrraysblog'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
  
    </div>
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:potatoker.github.io">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/">RRRay</a>
	</h1>
	<span class="copyright">
		&copy; 2016 RRRay<br>
		Modify from <a href="http://sanographix.github.io/tumblr/apollo/" target="_blank">Apollo</a> theme, designed by <a href="http://www.sanographix.net/" target="_blank">SANOGRAPHIX.NET</a><br>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js" type="text/javascript"></script>
  </div>
</body>
</html>